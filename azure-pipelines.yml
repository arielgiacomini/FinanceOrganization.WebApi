# Pseudocode / Plan (detailed):
# - Use a Windows hosted agent because msdeploy.exe is required.
# - Install .NET 6 SDK.
# - Restore, build and publish the WebAPI to a local publish folder.
# - Archive the publish folder into a zip package.
# - Locate msdeploy.exe on the agent (common Program Files paths or in PATH).
# - Run msdeploy.exe with the publish-profile MSDeployServiceURL, username and a secret password variable.
# - Fail the pipeline if msdeploy.exe is not found.
# - Provide a secret pipeline variable named "msdeployPassword" (do NOT store it here).
#
# Notes:
# - The MSDeployServiceURL and DeployIisAppPath taken from your publish profile are embedded as variables.
# - Set the secret variable "msdeployPassword" in the pipeline UI or a variable group before running.
# - This pipeline does not auto-trigger (trigger: none). Adjust triggers as needed.

trigger: none
pr: none

variables:
  vmImage: 'windows-latest'
  buildConfiguration: 'Release'
  targetFramework: 'net6.0'
  packageFolder: '$(Build.ArtifactStagingDirectory)/publish'
  packageZip: '$(Build.ArtifactStagingDirectory)/publish.zip'
  # From publish profile:
  msdeployServiceUrl: 'https://win8130.site4now.net:8172/MsDeploy.axd?site=arielgiacomini-003-subsite6'
  msdeployUser: 'arielgiacomini-003'
  msdeploySite: 'arielgiacomini-003-subsite6'
  # NOTE: create a secret pipeline variable named "msdeployPassword" (no default here)

pool:
  vmImage: $(vmImage)

steps:
- task: UseDotNet@2
  displayName: 'Install .NET SDK'
  inputs:
    packageType: 'sdk'
    version: '6.0.x'
    includePreviewVersions: false

- script: dotnet restore
  displayName: 'dotnet restore'

- script: dotnet build --no-restore -c $(buildConfiguration)
  displayName: 'dotnet build'

- script: dotnet publish --no-build -c $(buildConfiguration) -f $(targetFramework) -o "$(packageFolder)"
  displayName: 'dotnet publish'

- task: ArchiveFiles@2
  displayName: 'Create ZIP package'
  inputs:
    rootFolderOrFile: '$(packageFolder)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(packageZip)'
    replaceExistingArchive: true

- powershell: |
    Write-Host "Searching for msdeploy.exe..."
    $msdeploy = $null
    try { $msdeploy = (Get-Command msdeploy.exe -ErrorAction Stop).Source } catch {}
    if (-not $msdeploy) {
      $candidates = @(
        "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe",
        "C:\Program Files (x86)\IIS\Microsoft Web Deploy V3\msdeploy.exe"
      )
      $msdeploy = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
    }
    if (-not $msdeploy -or -not (Test-Path $msdeploy)) {
      Write-Error "msdeploy.exe not found on agent. Ensure agent image has Web Deploy installed or use a self-hosted agent."
      exit 1
    }
    Write-Host "Using msdeploy: $msdeploy"

    if (-not $Env:msdeployPassword) {
      Write-Error "Secret variable 'msdeployPassword' is not set. Set it in pipeline variables before running."
      exit 1
    }

    $serviceUrl = "$(msdeployServiceUrl)"
    $user = "$(msdeployUser)"
    $pwd = $Env:msdeployPassword
    $package = "$(packageZip)"

    # Build destination string. Using Basic auth (WMSVC). allowUntrusted used because remote cert may be untrusted.
    $dest = "auto,computerName='$serviceUrl',userName='$user',password='$pwd',authType='Basic'"

    Write-Host "Deploying package to $serviceUrl (site: $(msdeploySite))"
    & "$msdeploy" -verb:sync -source:package="$package" -dest:$dest -allowUntrusted -verbose
  displayName: 'Deploy with msdeploy'
  env:
    msdeployPassword: $(msdeployPassword)
  failOnStderr: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish build artifact (package)'
  inputs:
    PathToPublish: '$(packageZip)'
    ArtifactName: 'webapp-package'
    publishLocation: 'Container'